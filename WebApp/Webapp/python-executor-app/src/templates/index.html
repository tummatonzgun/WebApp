{% extends "base.html" %}

{% block title %}IE Function Portal{% endblock %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="header-content">
            <i class="fas fa-cogs header-icon"></i>
            <h1>IE Function</h1>
            <p class="header-subtitle"></p>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="alert-messages">
        {% for category, message in messages %}
        <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible">
            <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'info-circle' }}"></i>
            {{ message }}
            <button type="button" class="btn-close" onclick="this.parentElement.remove()">×</button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <!-- Main Form -->
    <div class="form-container">
        <form method="post" enctype="multipart/form-data" id="mainForm" class="main-form">
            
            <!-- Operation Selection -->
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-tasks"></i> เลือก Operation:
                </label>
                <div class="operation-grid">
                    <button type="button" class="operation-btn" data-operation="Singulation">
                        <div class="icon">
                            <i class=""></i>
                        </div>
                        <div class="title">Singulation</div>
                        <div class="description"></div>
                    </button>
                    <button type="button" class="operation-btn" data-operation="Pick & Place">
                        <div class="icon">
                            <i class=""></i>
                        </div>
                        <div class="title">Pick & Place</div>
                        <div class="description"></div>
                    </button>
                    <button type="button" class="operation-btn" data-operation="DA">
                        <div class="icon">
                            <i class=""></i>
                        </div>
                        <div class="title">DA</div>
                        <div class="description"></div>
                    </button>
                    <button type="button" class="operation-btn" data-operation="WB">
                        <div class="icon">
                            <i class=""></i>
                        </div>
                        <div class="title">WB</div>
                        <div class="description"></div>
                    </button>
                </div>
                <input type="hidden" name="operation" id="selectedOperation" required>
            </div>

            <!-- Function Selection -->
            <div class="form-group">
                <label for="funcSelect" class="form-label">
                    <i class="fas fa-cogs"></i> เลือกฟังก์ชัน:
                </label>
                <select name="func_name" id="funcSelect" class="form-control" required>
                    <option value="">เลือกฟังก์ชัน</option>
                </select>
            </div>

            <!-- Function Details -->
            <div id="functionDetails" class="form-group" style="display: none;">
                <div class="function-info">
                    <h4><i class="fas fa-info-circle"></i> รายละเอียดฟังก์ชัน</h4>
                    <div class="info-card">
                        <div class="info-section">
                            <label><i class="fas fa-file-alt"></i> คำอธิบาย:</label>
                            <p id="functionDescription">-</p>
                        </div>
                        <div class="info-section">
                            <label><i class="fas fa-file-upload"></i> ไฟล์ที่รองรับ:</label>
                            <p id="acceptedFiles">-</p>
                        </div>
                        <div class="info-section">
                            <label><i class="fas fa-lightbulb"></i> ตัวอย่าง:</label>
                            <p id="fileExample">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Date Range Preview -->
            <div id="datePreviewSection" class="form-group" style="display: none;">
                <div class="date-preview-info">
                    <h4><i class="fas fa-calendar-alt"></i> ข้อมูลวันที่ในไฟล์</h4>
                    <div class="preview-card">
                        <div class="preview-section">
                            <label><i class="fas fa-play"></i> วันที่เริ่มต้น:</label>
                            <p id="fileStartDate">-</p>
                        </div>
                        <div class="preview-section">
                            <label><i class="fas fa-stop"></i> วันที่สิ้นสุด:</label>
                            <p id="fileEndDate">-</p>
                        </div>
                        <div class="preview-section">
                            <label><i class="fas fa-calendar-days"></i> จำนวนวัน:</label>
                            <p id="fileTotalDays">-</p>
                        </div>
                        <div class="preview-section">
                            <label><i class="fas fa-database"></i> จำนวนข้อมูล:</label>
                            <p id="fileRecordCount">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Date Range Selection -->
            <div id="dateRangeSection" class="form-group" style="display: none;">
                <label class="form-label">
                    <i class="fas fa-calendar-alt"></i> ช่วงวันที่สำหรับการประมวลผล:
                </label>
                <div class="date-range-container">
                    <div class="date-input-group">
                        <label for="startDate">วันที่เริ่มต้น:</label>
                        <input type="date" id="startDate" name="start_date" class="form-control date-input">
                    </div>
                    <div class="date-separator">
                        <i class="fas fa-arrow-right"></i>
                    </div>
                    <div class="date-input-group">
                        <label for="endDate">วันที่สิ้นสุด:</label>
                        <input type="date" id="endDate" name="end_date" class="form-control date-input">
                    </div>
                </div>
                <div class="date-options">
                    <div class="option-item">
                        <input type="checkbox" id="useAllDates" name="use_all_dates" checked>
                        <label for="useAllDates">
                            <i class="fas fa-check-square"></i> ใช้ข้อมูลทั้งหมด (ไม่จำกัดช่วงวันที่)
                        </label>
                    </div>
                </div>
                <div class="date-info">
                    <p><i class="fas fa-info-circle"></i> หากเลือก "ใช้ข้อมูลทั้งหมด" ระบบจะใช้ข้อมูลทั้งหมดที่มีในไฟล์</p>
                </div>
            </div>

            <!-- File Input Selection -->
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-file-upload"></i> เลือกการจัดการไฟล์:
                </label>
                
                <!-- File Input Method Selection -->
                <div class="input-method-selector">
                    <div class="method-option">
                        <input type="radio" id="uploadMethod" name="inputMethod" value="upload" checked>
                        <label for="uploadMethod">
                            <i class="fas fa-upload"></i> อัปโหลดไฟล์
                        </label>
                    </div>
                    <div class="method-option">
                        <input type="radio" id="folderMethod" name="inputMethod" value="folder">
                        <label for="folderMethod">
                            <i class="fas fa-folder"></i> เลือกจากโฟลเดอร์
                        </label>
                    </div>
                </div>

                <!-- Upload File Section -->
                <div id="uploadSection" class="input-section">
                    <input type="file" name="input_files" id="fileInput" class="form-control" multiple 
                           accept=".xlsx,.xls,.csv,.txt">
                </div>

                <!-- Folder File Selection Section -->
                <div id="folderSection" class="input-section" style="display: none;">
                    <div class="folder-controls">
                        <select id="folderSelect" class="form-control">
                            <option value="">-- เลือกโฟลเดอร์ --</option>
                        </select>
                        <button type="button" id="refreshFolders" class="refresh-btn">
                            <i class="fas fa-sync-alt"></i> รีเฟรช
                        </button>
                    </div>
                    
                    <div id="fileListContainer" class="file-list-container" style="display: none;">
                        <div class="file-list-header">
                            <h4>ไฟล์ในโฟลเดอร์:</h4>
                            <div class="file-actions">
                                <button type="button" id="selectAllFiles" class="action-btn">
                                    <i class="fas fa-check-square"></i> เลือกทั้งหมด
                                </button>
                                <button type="button" id="clearSelection" class="action-btn">
                                    <i class="fas fa-times"></i> ยกเลิกการเลือก
                                </button>
                            </div>
                        </div>
                        <div id="fileList" class="file-list">
                            <!-- Files will be populated here dynamically -->
                        </div>
                    </div>
                    
                    <!-- Hidden inputs for selected files -->
                    <input type="hidden" name="selected_files" id="selectedFiles">
                    <input type="hidden" name="selected_folder" id="selectedFolder">
                </div>
            </div>

            <!-- Options -->
            <div class="form-group">
                <div class="form-options">
                    <div class="option-item">
                        <input type="checkbox" name="show_table" id="showTable" checked>
                        <label for="showTable">
                            <i class="fas fa-table"></i> แสดงผลลัพธ์บนเว็บ
                        </label>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-play"></i> เริ่มประมวลผล
                </button>
            </div>
        </form>

        <!-- Additional Features -->
        <div class="additional-features">
            <a href="{{ url_for('lookup_last_type_route') }}" id="lookupLastTypeLink" 
               class="btn btn-secondary" style="display: none;">
                <i class="fas fa-search"></i> ค้นหา Last_type จาก BOM
            </a>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading" class="loading">
        <div class="loading-content">
            <div class="loading-spinner">
                <i class="fas fa-cog fa-spin"></i>
            </div>
            <p>กำลังประมวลผล กรุณารอสักครู่...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script src="{{ url_for('static', filename='js/index.js') }}"></script>
{% endblock %}