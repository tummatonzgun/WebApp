from flask import Flask, request, render_template, redirect, url_for, flash, session, send_file
import os
import importlib
import tempfile
import shutil
import pandas as pd
import socket
import datetime
from functions.PNP_CHANG_TYPE import lookup_last_type

app = Flask(__name__)
app.secret_key = "your_secret_key_change_this_in_production"

BASE_DIR = os.path.dirname(os.path.abspath(__file__))
FUNCTIONS_DIR = os.path.join(BASE_DIR, "functions")

def list_functions():
    """List all available function modules"""
    files = []
    try:
        for f in os.listdir(FUNCTIONS_DIR):
            if f.endswith(".py") and not f.startswith("__"):
                files.append(f[:-3])
    except Exception as e:
        print(f"Error listing functions: {e}")
    return files

@app.route("/", methods=["GET", "POST"])
def index():
    functions = list_functions()
    
    if request.method == "POST":
        func_name = request.form.get("func_name")
        files = request.files.getlist("input_files")
        show_table = request.form.get("show_table") == "on"
        
        # Validation
        if not func_name or func_name == "":
            flash("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å function", "error")
            return redirect(url_for("index"))
            
        if not files or files[0].filename == "":
            flash("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå", "error")
            return redirect(url_for("index"))

        temp_input = tempfile.mkdtemp()
        output_dir = os.path.join(BASE_DIR, f"output_{func_name}")
        
        try:
            # Ensure output directory exists
            os.makedirs(output_dir, exist_ok=True)
            
            # Save uploaded files
            for f in files:
                if f.filename:
                    file_path = os.path.join(temp_input, f.filename)
                    f.save(file_path)
            
            # Import and run function
            module = importlib.import_module(f"functions.{func_name}")
            module.run(temp_input, output_dir)
            
            # Find output files
            output_files = [f for f in os.listdir(output_dir) if f.endswith((".xlsx", ".csv"))]
            if not output_files:
                flash("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÉ‡∏ô output", "error")
                return redirect(url_for("index"))

            # Get latest file
            output_files.sort(key=lambda x: os.path.getmtime(os.path.join(output_dir, x)), reverse=True)
            output_fp = os.path.join(output_dir, output_files[0])
            download_link = url_for("download_file", func_name=func_name, filename=output_files[0])

            # Handle table display
            if show_table:
                try:
                    if output_fp.endswith(".xlsx"):
                        df = pd.read_excel(output_fp)
                    else:
                        df = pd.read_csv(output_fp, encoding='utf-8')
                    
                    # Add row numbers and format table
                    df.index = range(1, len(df) + 1)
                    table_html = df.to_html(
                        classes="result-table table table-striped table-hover", 
                        table_id="dataTable",
                        index=True, 
                        border=0,
                        escape=False
                    )
                    
                    flash("‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success")
                    return render_template("result.html", 
                                         table_html=table_html, 
                                         download_link=download_link,
                                         total_records=len(df),
                                         func_name=func_name)
                except Exception as e:
                    flash(f"‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÑ‡∏î‡πâ: {str(e)}", "warning")
                    return render_template("result.html", 
                                         table_html=None, 
                                         download_link=download_link,
                                         func_name=func_name)
            else:
                flash("‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÑ‡∏î‡πâ", "success")
                return render_template("result.html", 
                                     table_html=None, 
                                     download_link=download_link,
                                     func_name=func_name)
                
        except Exception as e:
            flash(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {str(e)}", "error")
            print(f"Error in index route: {e}")
            return redirect(url_for("index"))
        finally:
            if os.path.exists(temp_input):
                shutil.rmtree(temp_input)
    
    return render_template("index.html", functions=functions)

@app.route("/result")
def result():
    """Redirect route for result page"""
    flash("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå", "error")
    return redirect(url_for("index"))

@app.route("/download/<func_name>/<filename>")
def download_file(func_name, filename):
    """Download processed files"""
    try:
        if func_name == 'lookup_last_type':
            output_dir = os.path.join(BASE_DIR, "output_lookup_last_type")
        else:
            output_dir = os.path.join(BASE_DIR, f"output_{func_name}")
        
        file_path = os.path.join(output_dir, filename)
        
        if not os.path.exists(file_path):
            flash("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î", "error")
            return redirect(url_for("index"))
        
        return send_file(file_path, as_attachment=True)
    except Exception as e:
        flash(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î: {str(e)}", "error")
        return redirect(url_for("index"))

@app.route("/lookup_last_type", methods=["GET", "POST"]) 
def lookup_last_type_route():
    table_html = None
    download_link = None
    total_records = 0
    
    if request.method == "POST":
        # Debug: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤
        print(f"üì® Form data: {request.form}")
        print(f"üìÅ Files: {request.files}")
        print(f"üìã Files keys: {list(request.files.keys())}")
        
        file = request.files.get("file")
        print(f"üîç File object: {file}")
        print(f"üìÑ File name: {file.filename if file else 'None'}")
        
        if not file or file.filename == "":
            flash("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå", "error")
            return redirect(url_for("lookup_last_type_route"))
        
        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå
        if not file.filename.lower().endswith(('.xlsx', '.xls')):
            flash("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx ‡∏´‡∏£‡∏∑‡∏≠ .xls) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô", "error")
            return redirect(url_for("lookup_last_type_route"))
        
        temp_dir = tempfile.mkdtemp()
        file_path = os.path.join(temp_dir, file.filename)
        
        try:
            # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô
            file.save(file_path)
            
            # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß
            try:
                temp_df = pd.read_excel(file_path)
                print(f"üìã ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: {list(temp_df.columns)}")
                
                # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå bom_no
                has_bom = any(str(col).lower().strip() in ['bom_no', 'bomno', 'bom no', 'bom_number'] 
                             for col in temp_df.columns)
                
                if not has_bom:
                    available_cols = ", ".join(str(col) for col in temp_df.columns)
                    flash(f"‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå bom_no - ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ: {available_cols}", "error")
                    return redirect(url_for("lookup_last_type_route"))
                    
            except Exception as read_error:
                flash(f"‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel ‡πÑ‡∏î‡πâ: {str(read_error)}", "error")
                return redirect(url_for("lookup_last_type_route"))
            
            # ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ lookup
            output_dir = os.path.join(BASE_DIR, "output_PNP_CHANG_TYPE")
            os.makedirs(output_dir, exist_ok=True)
            
            print(f"üîç ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...")
            df_result = lookup_last_type(file_path, output_dir)
            
            if df_result is not None and not df_result.empty:
                # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏Ç‡πÅ‡∏ñ‡∏ß
                df_result.index = range(1, len(df_result) + 1)
                table_html = df_result.to_html(
                    classes="result-table table table-striped table-hover", 
                    table_id="dataTable",
                    index=True, 
                    border=0,
                    escape=False
                )
                
                # Save result
                download_dir = os.path.join(BASE_DIR, "output_lookup_last_type")
                os.makedirs(download_dir, exist_ok=True)
                
                timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
                filename = f"last_type_result_{timestamp}.xlsx"
                result_path = os.path.join(download_dir, filename)
                df_result.to_excel(result_path, index=False)
                
                download_link = url_for('download_file', func_name='lookup_last_type', filename=filename)
                total_records = len(df_result)
                
                # ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏ö‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏û‡∏ö
                found_count = df_result['Last_type'].notna().sum() if 'Last_type' in df_result.columns else 0
                not_found_count = total_records - found_count
                
                flash(f"‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô: ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• {found_count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£, ‡πÑ‡∏°‡πà‡∏û‡∏ö {not_found_count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", "success")
            else:
                flash("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô", "warning")
                
        except Exception as e:
            error_msg = str(e)
            print(f"‚ùå Error details: {error_msg}")
            
            if "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå Last_Type.xlsx" in error_msg:
                flash("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå Last_Type.xlsx ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Upload ‡∏´‡∏£‡∏∑‡∏≠ output_PNP_CHANG_TYPE", "error")
            elif "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå bom_no" in error_msg:
                flash("‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå bom_no ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå", "error")
            elif "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: ['bom_no', 'Last_type']" in error_msg or "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: ['Last_type']" in error_msg:
                flash("‡πÑ‡∏ü‡∏•‡πå Last_Type.xlsx ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (bom_no, Last_type)", "error")
            else:
                flash(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {error_msg}", "error")
                
        finally:
            if os.path.exists(temp_dir):
                shutil.rmtree(temp_dir)
    
    return render_template("lookup_last_type.html", 
                         table_html=table_html, 
                         download_link=download_link,
                         total_records=total_records)

@app.errorhandler(404)
def not_found_error(error):
    """Handle 404 errors"""
    return render_template('404.html'), 404

@app.errorhandler(500)
def internal_error(error):
    """Handle 500 errors"""
    return render_template('500.html'), 500

@app.errorhandler(Exception)
def handle_exception(e):
    """Handle all other exceptions"""
    print(f"Unhandled exception: {e}")
    flash("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏≤‡∏î‡∏Ñ‡∏¥‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á", "error")
    return redirect(url_for("index"))

if __name__ == "__main__":
    # Ensure output directories exist
    os.makedirs(os.path.join(BASE_DIR, "output_lookup_last_type"), exist_ok=True)
    os.makedirs(FUNCTIONS_DIR, exist_ok=True)
    
    # Get local IP
    try:
        ip = socket.gethostbyname(socket.gethostname())
        print(f"üöÄ IE Function : Starting...")
        print(f"   Local:   http://127.0.0.1:80")
        print(f"   Network: http://{ip}:80")
        print(f"   Debug:   {app.debug}")
        print(f"   Functions: {list_functions()}")
    except Exception as e:
        print(f"Network detection failed: {e}")
        ip = "127.0.0.1"
    
    # Use port 80 
    app.run(debug=True, host='0.0.0.0', port=80, threaded=True)