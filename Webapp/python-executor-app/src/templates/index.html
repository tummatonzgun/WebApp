{% extends "base.html" %}

{% block title %}IE Function Portal{% endblock %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
{% endblock %}

{% block content %}
    <div class="main-container">
        <div class="header">
            <i class="fas fa-cogs icon"></i>
            <h1>IE Function</h1>
        </div>

        {% with messages = get_flashed_messages() %}
          {% if messages %}
            <div class="alert-messages">
              {% for message in messages %}
                <div class="alert">
                  <i class="fas fa-info-circle"></i> {{ message }}
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        <div class="form-container">
            <form method="post" enctype="multipart/form-data" id="mainForm">
                <div class="form-group">
                    <label class="section-label">
                        <i class="fas fa-tasks"></i>เลือก Operation:
                    </label>
                    <div class="operation-buttons">
                        <button type="button" class="operation-btn" data-operation="Singulation">
                            <i class="fas fa-database"></i>
                            <span>Singulation</span>
                        </button>
                        <button type="button" class="operation-btn" data-operation="Pick & Place">
                            <i class="fas fa-file-alt"></i>
                            <span>Pick & Places</span>
                        </button>
                        <button type="button" class="operation-btn" data-operation="DA">
                            <i class="fas fa-chart-line"></i>
                            <span>DA</span>
                        </button>
                        <button type="button" class="operation-btn" data-operation="WB">
                            <i class="fas fa-list-ul"></i>
                            <span>WB</span>
                        </button>
                    </div>
                    <input type="hidden" name="operation" id="selectedOperation" required>
                </div>

                <div class="form-group">
                    <label for="funcSelect">
                        <i class="fas fa-function"></i>เลือกฟังก์ชัน:
                    </label>
                    <select name="func_name" id="funcSelect" class="form-control" required disabled>
                        <option value="">-- กรุณาเลือก Operation ก่อน --</option>
                        {% for func in functions %}
                        <option value="{{ func }}">{{ func }}</option>
                        {% endfor %}
                    </select>
                    
                    <!-- คำแนะนำไฟล์ -->
                    <div id="fileGuidance" class="file-guidance" style="display:none;">
                        <div class="guidance-header">
                            <i class="fas fa-info-circle"></i>
                            <span>คำแนะนำไฟล์สำหรับฟังก์ชันที่เลือก</span>
                        </div>
                        <div id="guidanceContent" class="guidance-content">
                            <!-- เนื้อหาจะถูกเพิ่มด้วย JavaScript -->
                        </div>
                    </div>

                    <!-- LOGVIEW File Selection -->
                    <div id="logviewOptions" class="logview-options" style="display:none;">
                        <div class="logview-header">
                            <i class="fas fa-folder-open"></i>
                            <span>ตัวเลือกสำหรับ LOGVIEW</span>
                        </div>
                        
                        <div class="processing-mode">
                            <label class="radio-label">
                                <input type="radio" name="processing_mode" value="selected_files" checked>
                                <span>เลือกไฟล์เฉพาะ</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="processing_mode" value="all_files">
                                <span>ประมวลผลทั้งหมดในโฟลเดอร์ data_all</span>
                            </label>
                        </div>

                        <div id="fileSelector" class="file-selector">
                            <label for="dataAllFiles">เลือกไฟล์จาก data_all:</label>
                            <select name="selected_data_files" id="dataAllFiles" class="form-control" multiple size="8">
                                <!-- ไฟล์จะถูกโหลดด้วย AJAX -->
                            </select>
                            <div class="file-selector-actions">
                                <button type="button" id="selectAllFiles" class="btn-small">เลือกทั้งหมด</button>
                                <button type="button" id="clearAllFiles" class="btn-small">ล้างทั้งหมด</button>
                                <button type="button" id="refreshFiles" class="btn-small">รีเฟรช</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group" id="regularFileUpload">
                    <label for="fileInput">
                        <i class="fas fa-upload"></i>อัปโหลดไฟล์ (เลือกได้หลายไฟล์):
                    </label>
                    <input type="file" name="input_files" id="fileInput" class="form-control" multiple>
                </div>

                <div class="form-group">
                    <div class="checkbox-container">
                        <input type="checkbox" name="show_table" id="showTable" checked>
                        <label for="showTable">
                            <i class="fas fa-table"></i>แสดงผลลัพธ์บนเว็บ
                        </label>
                    </div>
                </div>

                <button type="submit" class="submit-btn">
                    <i class="fas fa-play"></i> เริ่มประมวลผล
                </button>
            </form>

            <!-- ลิงก์ค้นหา Last_type -->
            <a href="{{ url_for('lookup_last_type_route') }}" id="lookupLastTypeLink" class="feature-btn" style="display:none;">
                <i class="fas fa-search"></i>ค้นหา Last_type จาก BOM
            </a>
        </div>

        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <div class="loading-content">
                <i class="fas fa-cog fa-spin"></i> กำลังประมวลผล กรุณารอสักครู่...
            </div>
        </div>
    </div>
{% endblock %}

{% block js %}
<script src="{{ url_for('static', filename='js/index.js') }}"></script>
<script>
// ข้อมูลคำแนะนำไฟล์สำหรับแต่ละฟังก์ชัน
const fileGuidanceData = {
    "WB": {
        "LOGVIEW": {
            acceptedFiles: ["Text Files (.txt)", "Log Files (.log)"],
            description: "ไฟล์ Log จาก Wire Bond Machine ที่มีข้อมูล frame, speed, และ sec/strip",
            example: "ตัวอย่าง: WB_log_20241201.txt, machine_data.log"
        }
    },
    // ...existing operations...
};

// เพิ่มการจัดการเมื่อเลือกฟังก์ชัน
document.getElementById('funcSelect').addEventListener('change', function() {
    const selectedFunction = this.value;
    const selectedOperation = document.getElementById('selectedOperation').value;
    const guidanceDiv = document.getElementById('fileGuidance');
    const guidanceContent = document.getElementById('guidanceContent');
    const logviewOptions = document.getElementById('logviewOptions');
    const regularFileUpload = document.getElementById('regularFileUpload');
    
    // แสดง/ซ่อน LOGVIEW options
    if (selectedFunction === 'LOGVIEW') {
        logviewOptions.style.display = 'block';
        loadDataAllFiles();
        setupLogviewHandlers();
    } else {
        logviewOptions.style.display = 'none';
        regularFileUpload.style.display = 'block';
    }
    
    // แสดงคำแนะนำไฟล์
    if (selectedFunction && selectedOperation && fileGuidanceData[selectedOperation] && fileGuidanceData[selectedOperation][selectedFunction]) {
        const guidance = fileGuidanceData[selectedOperation][selectedFunction];
        
        guidanceContent.innerHTML = `
            <div class="file-types">
                <strong>ประเภทไฟล์ที่รองรับ:</strong>
                <ul class="file-list">
                    ${guidance.acceptedFiles.map(file => `<li>${file}</li>`).join('')}
                </ul>
            </div>
            <div class="description">
                <strong>คำอธิบาย:</strong> ${guidance.description}
            </div>
            <div class="example-section">
                <strong>ตัวอย่าง:</strong> ${guidance.example}
            </div>
        `;
        
        guidanceDiv.style.display = 'block';
    } else {
        guidanceDiv.style.display = 'none';
    }
});

// ฟังก์ชันโหลดไฟล์จากโฟลเดอร์ data_all
async function loadDataAllFiles() {
    try {
        const response = await fetch('/api/get_data_all_files');
        const data = await response.json();
        
        const select = document.getElementById('dataAllFiles');
        select.innerHTML = '';
        
        if (data.files && data.files.length > 0) {
            data.files.forEach(file => {
                const option = document.createElement('option');
                option.value = file;
                option.textContent = file;
                select.appendChild(option);
            });
        } else {
            const option = document.createElement('option');
            option.textContent = 'ไม่พบไฟล์ในโฟลเดอร์ data_all';
            option.disabled = true;
            select.appendChild(option);
        }
    } catch (error) {
        console.error('Error loading data_all files:', error);
        const select = document.getElementById('dataAllFiles');
        select.innerHTML = '<option disabled>เกิดข้อผิดพลาดในการโหลดไฟล์</option>';
    }
}

// ตั้งค่า event handlers สำหรับ LOGVIEW
function setupLogviewHandlers() {
    const processingModeRadios = document.querySelectorAll('input[name="processing_mode"]');
    const fileSelector = document.getElementById('fileSelector');
    const regularFileUpload = document.getElementById('regularFileUpload');
    
    processingModeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'selected_files') {
                fileSelector.style.display = 'block';
                regularFileUpload.style.display = 'none';
            } else {
                fileSelector.style.display = 'none';
                regularFileUpload.style.display = 'none';
            }
        });
    });
    
    // ปุ่มเลือกทั้งหมด
    document.getElementById('selectAllFiles').addEventListener('click', function() {
        const select = document.getElementById('dataAllFiles');
        for (let option of select.options) {
            option.selected = true;
        }
    });
    
    // ปุ่มล้างทั้งหมด
    document.getElementById('clearAllFiles').addEventListener('click', function() {
        const select = document.getElementById('dataAllFiles');
        for (let option of select.options) {
            option.selected = false;
        }
    });
    
    // ปุ่มรีเฟรช
    document.getElementById('refreshFiles').addEventListener('click', function() {
        loadDataAllFiles();
    });
}

// อัปเดต form submission
document.getElementById('mainForm').addEventListener('submit', function(e) {
    const selectedFunction = document.getElementById('funcSelect').value;
    
    if (selectedFunction === 'LOGVIEW') {
        const processingMode = document.querySelector('input[name="processing_mode"]:checked').value;
        
        if (processingMode === 'selected_files') {
            const selectedFiles = Array.from(document.getElementById('dataAllFiles').selectedOptions);
            if (selectedFiles.length === 0) {
                e.preventDefault();
                alert('กรุณาเลือกไฟล์อย่างน้อย 1 ไฟล์');
                return;
            }
        }
    }
});
</script>
{% endblock %}